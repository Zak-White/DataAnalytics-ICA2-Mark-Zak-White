---
title: "Ica-2-DAIE-MXW"
---

This is a Quarto website.

To learn more about Quarto websites visit <https://quarto.org/docs/websites>.

```{r}
library(DBI)

library(RSQLite)

library(dplyr)

library(lubridate)

library(stringr)

library(tidyverse)

Icadb <- dbConnect(SQLite(), "ICA_2023.sqlite")

dbListTables(Icadb)

dbListFields(Icadb, "Projects")

Projects <- tbl(Icadb, "Projects")

projects_df <- collect(Projects)

projects_df

projects_df2 <- collect(Projects)

projects_df2

Assets <- tbl(Icadb, "Assets")

assets_df <- collect(Assets)

assets_df

Developers <- tbl(Icadb, "Developers")

developers_df <- collect(Developers)

developers_df

Timelines <- tbl(Icadb, "Timelines")

timelines_df <- collect(Timelines)

timelines_df

Customers <- tbl(Icadb, "Customers")

Customers_df <- collect(Customers)

Customers_df

ProjectDevelopers <- tbl(Icadb, "ProjectDevelopers")

projectdevelopers_df <- collect(ProjectDevelopers)

projectdevelopers_df

projectdevelopers_df2 <- collect(ProjectDevelopers)

projectdevelopers_df2

AssetsDevelopers <- tbl(Icadb, "AssetsDevelopers")

assetsdevelopers_df <- collect(AssetsDevelopers)

assetsdevelopers_df


dbRemoveTable(Icadb, "ProjectsBudget")
dbExecute(Icadb, "CREATE Table ProjectsBudget AS

                  SELECT Budget, CustomerCountry

                 FROM Projects, Customers")
#dbReadTable(Icadb, "ProjectsBudget")

#A-1 Mostly working just not printing in correct order but the code is all there
ProjectsBudget_df <-inner_join( Customers_df, projects_df,
                                      by = c("CustomerID"))
ProjectsBudget_df <- ProjectsBudget_df[,-c(2,3,5,7,8,10)]
ProjectsBudget_df <- ProjectsBudget_df[order(-ProjectsBudget_df$Budget),] # Should showcase the order correctly but it no longer does. This works before the summarise?
ProjectsBudget_df <- ProjectsBudget_df %>% group_by(CustomerCountry)
ProjectsBudget_df <- ProjectsBudget_df %>% arrange(desc(Budget))
ProjectsBudget_df <- ProjectsBudget_df %>% summarise(sum(Budget))
ProjectsBudget_df

#A-2 I got the days between and I have the mean code there but this question would not cooperate with me at all
AssetsProjects_df <- inner_join(projects_df, assets_df,
                                by = c("ProjectID"))
AssetsProjects_df <-AssetsProjects_df[,-c(5,6,7,8,9,10)]
AssetsProjects_df <- AssetsProjects_df %>% group_by(ProjectID) %>% mutate(EndDate = ymd(EndDate),StartDate = ymd(StartDate)) %>% mutate(diff=as.numeric(difftime(EndDate, StartDate, units = "days"))) %>% mutate(meanDays = mean(diff)) 

AssetsProjects_df

#A-3 Going to create a table that adds projects and developers and where the project is completed it will print that out
status <- projects_df$Status
status
ComStatus <- sum(str_count(status, "Completed"))
projectdevelopers_df
projectdevelopers_df <- projectdevelopers_df %>% mutate(Status = status) %>% group_by(DeveloperID) %>% summarize(DevComplete = ComStatus) %>% arrange(desc(ComStatus))
#I am not sure why they are all equal to 4 as I thought the group by would split it per case but This is the basics of How you would do this question
projectdevelopers_df <-projectdevelopers_df[1:3,] #This is how you select the top 3 values
projectdevelopers_df

# Custom SQL Query 1 = Select specific budget ranges from the project table 
#Filter is the dplyr libraries version of Like and or according to multiple articles I read https://sebastiansauer.github.io/dplyr_filter/ and https://stackoverflow.com/questions/32829358/dplyr-filter-with-sql-like-wildcard
projects_df <- projects_df %>% filter(Budget > 200000) %>% filter(Budget < 350000)
projects_df

#custom query 2: Select projectID and AssetID from asset table using the distinct function and the arrange which is dplyrs version of the SQL query DISTINCT and ORDER_BY Reference: https://sparkbyexamples.com/r-programming/dplyr-arrange-function-in-r/#:~:text=R%20arrange()%20Ascending%20Order,either%20ascending%20or%20descending%20order.
assets_df <- assets_df %>% distinct(assets_df, pick(contains("ID"))) %>% arrange(desc(AssetID)) %>% arrange(desc(ProjectID))
assets_df


#PART B:
#Setting up the data to be modelled.
TimeLineBudget_df <- inner_join(timelines_df, projects_df2,
                                by = c("ProjectID"))
TimeLineBudget_df
```
